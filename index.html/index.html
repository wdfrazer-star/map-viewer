<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Mapping Company ‚Äì Map Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- GeometryUtil for measuring polygon areas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.geometryutil/0.10.0/leaflet.geometryutil.min.js"></script>

  <!-- Proj4 for OS Grid conversions -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.1/proj4.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, sans-serif;
    }

    #toolbar {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 50px;
      background: #fff;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    #toolbar-left { display: flex; align-items: center; gap: 10px; }
    #toolbar-left img, #toolbar-left svg { height: 28px; width: auto; }
    #toolbar-center { flex: 1; display: flex; justify-content: center; }
    #toolbar-center input { width: 400px; max-width: 80%; padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; }
    #toolbar-right { display: flex; gap: 8px; }
    .tool-btn { background: #f9f9f9; border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px; cursor: pointer; transition: all 0.2s; }
    .tool-btn:hover { background: #eee; }
    #map { height: calc(100vh - 50px); width: 100%; margin-top: 50px; }
    .leaflet-top.leaflet-left { top: 70px; }
    .leaflet-top.leaflet-right { top: 70px; }
    #coord-box { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 1px solid #ccc; border-radius: 6px; padding: 5px 10px; font-size: 13px; z-index: 999; }
    .area-label { background: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; border-radius: 4px; padding: 4px; font-size: 12px; color: #333; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #ccc; border-radius: 6px; z-index: 1000; min-width: 150px; }
    .dropdown-content .dropdown-item { padding: 8px 12px; cursor: pointer; text-align: left; border: none; background: none; width: 100%; }
    .dropdown-content .dropdown-item:hover { background-color: #f1f1f1; }
    .dropdown-content .dropdown-item.selected { background-color: #e0e0e0; font-weight: bold; }
    .dropdown:hover .dropdown-content, .dropdown-content:hover { display: block; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div id="toolbar-left">
      <svg width="32" height="32" viewBox="0 0 32 32">
        <rect x="0" y="0" width="32" height="32" fill="#1f2937" rx="6"/>
        <path d="M6 22 L14 10 L20 18 L26 12" stroke="#10b981" stroke-width="3" fill="none"/>
      </svg>
      <strong>The Mapping Company</strong>
    </div>
    <div id="toolbar-center">
      <input type="text" id="searchInput" placeholder="Search address or postcode..." />
    </div>
    <div id="toolbar-right">
      <button class="tool-btn" id="drawBtn">‚úèÔ∏è Draw</button>
      <div class="dropdown">
        <button class="tool-btn">üó∫Ô∏è Base Maps</button>
        <div class="dropdown-content" id="baseMapsDropdown">
          <button class="dropdown-item" data-layer="OpenStreetMap">OpenStreetMap</button>
          <button class="dropdown-item" data-layer="OS Zoomstack Light">OS Zoomstack Light</button>
          <button class="dropdown-item" data-layer="ESRI Satellite">ESRI Satellite</button>
        </div>
      </div>
      <div class="dropdown">
        <button class="tool-btn">üìö Map Layers</button>
        <div class="dropdown-content" id="mapLayersDropdown">
          <button class="dropdown-item" data-layer="Footpaths">Footpaths</button>
          <button class="dropdown-item" data-layer="Water">Water</button>
          <button class="dropdown-item" data-layer="Utilities">Utilities</button>
          <button class="dropdown-item" data-layer="Local Authority Boundaries">Local Authority Boundaries</button>
          <button class="dropdown-item" data-layer="County Boundaries">County Boundaries</button>
          <button class="dropdown-item" data-layer="ONS LADs">ONS LADs</button>
        </div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <div id="coord-box">Grid: -</div>
  <div id="data-status" style="position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,0.95);border:1px solid #ccc;border-radius:6px;padding:6px 10px;font-size:13px;z-index:999;">
    <span id="data-status-text">Counties: loading...</span>
  </div>
<script>
  // === MAP INITIALISATION ===
  const map = L.map('map').setView([51.0, -1.0], 7); // UK-wide start

  // === BASEMAPS ===
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  const osZoomstack = L.tileLayer(
    'https://api.os.uk/maps/raster/v1/zxy/Light_3857/{z}/{x}/{y}.png?key=YOUR_API_KEY',
    { maxZoom: 19, attribution: '¬© Ordnance Survey' }
  );

  const esriSat = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: 'Tiles ¬© Esri' }
  );

  const baseMaps = {
    "OpenStreetMap": osm,
    "OS Zoomstack Light": osZoomstack,
    "ESRI Satellite": esriSat
  };

  // === LOCAL AUTHORITY BOUNDARIES (MAIN DATASET) ===
  const laUrl = encodeURI(
    'https://raw.githubusercontent.com/wdfrazer-star/map-viewer/main/data/counties.geojson/Local_Authority_Districts_(May_2025)_Boundaries_UK_BUC.geojson'
  );

  const laLayer = L.geoJSON(null, {
    style: {
      color: '#7b3294',
      weight: 2,
      fillColor: '#b2a5d9',
      fillOpacity: 0.3
    },
    onEachFeature: (feature, layer) => {
      const props = feature.properties || {};
      const name = props.LAD23NM || props.LAD20NM || props.NAME || props.name || "Local Authority";
      layer.bindPopup(`<strong>${name}</strong>`);
    }
  });

  const dataStatusText = document.getElementById('data-status-text');

  // === CRS definitions for reprojection if needed ===
  const WGS84 = 'EPSG:4326';
  const OSGB36 = '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.1502,0.2470,0.8421,-20.4894 +units=m +no_defs';

  function findCoord(obj) {
    if (!obj) return null;
    if (obj.type === 'FeatureCollection' && obj.features?.length) return findCoord(obj.features[0]);
    if (obj.type === 'Feature') return findCoord(obj.geometry);
    if (Array.isArray(obj.coordinates)) {
      let c = obj.coordinates;
      while (Array.isArray(c) && Array.isArray(c[0])) c = c[0];
      return c;
    }
    return null;
  }

  function transformCoords(coords, fn) {
    if (typeof coords[0] === 'number') return fn(coords);
    return coords.map(c => transformCoords(c, fn));
  }

  async function loadLocalAuthorities() {
    try {
      dataStatusText.textContent = 'Local Authorities: fetching...';
      const r = await fetch(laUrl);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();

      // Reproject if needed (detects metre coordinates)
      const sample = findCoord(data);
      if (sample && Math.abs(sample[0]) > 1000 && Math.abs(sample[1]) > 1000) {
        data.features.forEach(f => {
          if (f.geometry?.coordinates) {
            f.geometry.coordinates = transformCoords(
              f.geometry.coordinates,
              c => proj4(OSGB36, WGS84, c)
            );
          }
        });
        console.log('Reprojected Local Authorities from OSGB36 ‚Üí WGS84');
      }

      laLayer.clearLayers();
      laLayer.addData(data);

      // Add to map initially OFF ‚Äî only show when toggled
      dataStatusText.textContent = `Local Authorities: ready (${data.features.length} features)`;
    } catch (e) {
      console.error('Failed to load Local Authorities:', e);
      dataStatusText.textContent = `Local Authorities: failed (${e.message})`;
    }
  }

  loadLocalAuthorities();

  // === DRAWING TOOLS ===
  const drawnItems = new L.FeatureGroup().addTo(map);
  const drawControl = new L.Control.Draw({
    draw: { polygon: true, polyline: true, rectangle: true, circle: true, marker: true },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED, e => {
    const layer = e.layer;
    if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
      const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
      const ha = area / 10000;
      const acres = area / 4046.8564224;
      const center = layer.getBounds().getCenter();
      L.marker(center, {
        icon: L.divIcon({
          className: 'area-label',
          html: `<strong>${ha.toFixed(2)} ha</strong><br>${acres.toFixed(2)} acres`,
          iconSize: [100, 40]
        }),
        interactive: false
      }).addTo(map);
    }
    drawnItems.addLayer(layer);
  });

  // === SCALEBAR ===
  L.control.scale({ position: 'bottomleft', metric: true, imperial: true }).addTo(map);

  // === TOGGLE MAP LAYERS DROPDOWN ===
  document.querySelectorAll('#mapLayersDropdown .dropdown-item').forEach(item => {
    item.onclick = () => {
      const name = item.getAttribute('data-layer');
      if (name === 'Local Authority Boundaries') {
        if (map.hasLayer(laLayer)) {
          map.removeLayer(laLayer);
          item.classList.remove('selected');
        } else {
          laLayer.addTo(map);
          item.classList.add('selected');
          map.fitBounds(laLayer.getBounds());
        }
      }
    };
  });

  // === BASEMAP DROPDOWN ===
  document.querySelectorAll('#baseMapsDropdown .dropdown-item').forEach(item => {
    item.onclick = () => {
      const name = item.getAttribute('data-layer');
      Object.entries(baseMaps).forEach(([n, l]) => (n === name ? l.addTo(map) : map.removeLayer(l)));
      document.querySelectorAll('#baseMapsDropdown .dropdown-item').forEach(i => i.classList.remove('selected'));
      item.classList.add('selected');
    };
  });

  // === SEARCH BOX ===
  document.getElementById('searchInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const q = e.target.value.trim();
      if (!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(results => {
          if (results.length) {
            const c = results[0];
            const latlng = [parseFloat(c.lat), parseFloat(c.lon)];
            map.setView(latlng, 14);
            L.marker(latlng).addTo(map).bindPopup(c.display_name).openPopup();
          } else alert("Location not found");
        })
        .catch(err => console.error('Search error:', err));
    }
  });

  // === OS GRID COORDINATES ===
  map.on('mousemove', e => {
    const [E, N] = proj4(WGS84, OSGB36, [e.latlng.lng, e.latlng.lat]);
    document.getElementById('coord-box').innerText = `Grid: ${E.toFixed(0)}E, ${N.toFixed(0)}N`;
  });
</script>

</body>
</html>
